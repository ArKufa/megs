<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ü–µ–Ω—Ç—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0c0c0c;
            color: #00ff00;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* CRT —ç—Ñ—Ñ–µ–∫—Ç */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: #1a1a1a;
            padding: 20px;
            border: 1px solid #333;
            margin-bottom: 20px;
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info h1 {
            font-size: 1.8em;
            font-weight: 300;
            color: #00ff00;
            margin-bottom: 5px;
            text-shadow: 0 0 10px #00ff00;
        }

        .header-stats {
            display: flex;
            gap: 20px;
        }

        .stat-badge {
            background: #0c0c0c;
            padding: 8px 15px;
            border: 1px solid #333;
            color: #0f0;
            font-size: 0.9em;
        }

        /* –ü–∞–Ω–µ–ª–∏ */
        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #0c0c0c;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            color: #0f0;
            font-weight: bold;
        }

        .panel-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        /* –ö–æ–Ω—Ç–∞–∫—Ç—ã */
        .contact-item {
            background: #0c0c0c;
            padding: 12px 15px;
            margin: 8px 0;
            border: 1px solid #333;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .contact-item:hover {
            border-color: #0f0;
            background: #252525;
        }

        .contact-item.in-call {
            border-color: #ff4444;
            background: #2a1a1a;
        }

        .contact-codename {
            color: #fff;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .contact-status {
            font-size: 0.8em;
            color: #666;
        }

        .contact-status.online {
            color: #0f0;
        }

        .contact-status.in-call {
            color: #ff4444;
        }

        .contact-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .btn-call, .btn-message {
            padding: 4px 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #0f0;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .btn-call:hover {
            background: #0f0;
            color: #000;
        }

        .btn-message:hover {
            background: #00aaff;
            color: #000;
        }

        /* –ó–∞–¥–∞–Ω–∏—è */
        .mission-item {
            background: #0c0c0c;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #333;
            border-left: 4px solid #333;
        }

        .mission-item.high {
            border-left-color: #ff4444;
        }

        .mission-item.medium {
            border-left-color: #ffaa00;
        }

        .mission-item.low {
            border-left-color: #00ff00;
        }

        .mission-title {
            color: #fff;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .mission-description {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .mission-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: #666;
        }

        .mission-assigned {
            color: #0f0;
        }

        .btn-assign, .btn-complete {
            padding: 4px 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #0f0;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 8px;
        }

        .btn-complete {
            background: #0f0;
            color: #000;
        }

        /* –ß–∞—Ç */
        .chat-area {
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #0c0c0c;
            border-bottom: 1px solid #333;
            max-height: 500px;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 12px;
            border-left: 3px solid #333;
            background: #1a1a1a;
            transition: all 0.3s ease;
        }

        .message:hover {
            border-left-color: #0f0;
            background: #252525;
        }

        .message.system {
            border-left-color: #ff4444;
            background: #2a1a1a;
        }

        .message.own {
            border-left-color: #00aaff;
            background: #1a1a2a;
        }

        .message-header {
            font-size: 0.8em;
            margin-bottom: 5px;
            color: #888;
        }

        .message-codename {
            color: #0f0;
            font-weight: bold;
        }

        .message-time {
            color: #666;
            float: right;
        }

        .message-text {
            color: #ccc;
            word-wrap: break-word;
        }

        .input-area {
            padding: 15px;
            background: #1a1a1a;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 10px 12px;
            background: #0c0c0c;
            border: 1px solid #333;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
        }

        .message-input:focus {
            border-color: #0f0;
            box-shadow: 0 0 10px #00ff00;
        }

        .send-button {
            padding: 10px 20px;
            background: #0c0c0c;
            border: 1px solid #333;
            color: #0f0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background: #0f0;
            color: #000;
        }

        /* –ó–≤–æ–Ω–æ–∫ */
        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .call-container {
            background: #1a1a1a;
            padding: 30px;
            border: 2px solid #0f0;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        .call-title {
            color: #0f0;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .call-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-accept, .btn-reject, .btn-end {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 1em;
        }

        .btn-accept {
            background: #0f0;
            color: #000;
        }

        .btn-reject, .btn-end {
            background: #f00;
            color: #fff;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-form {
            background: #1a1a1a;
            padding: 40px;
            border: 1px solid #333;
            width: 90%;
            max-width: 400px;
        }

        .login-title {
            color: #0f0;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #0c0c0c;
            border: 1px solid #333;
            color: #0f0;
            font-family: 'Courier New', monospace;
        }

        .join-button {
            width: 100%;
            padding: 12px;
            background: #0c0c0c;
            border: 1px solid #333;
            color: #0f0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0f0;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .panel {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2 class="login-title">üïµÔ∏è –î–û–°–¢–£–ü –ö –û–ü–ï–†–ê–¢–ò–í–ù–û–ú–£ –¶–ï–ù–¢–†–£</h2>
            <input type="text" class="login-input" id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20">
            <input type="text" class="login-input" id="codenameInput" placeholder="–ü–æ–∑—ã–≤–Ω–æ–π" maxlength="15">
            <button class="join-button" id="joinButton">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–≤–æ–Ω–∫–∞ -->
    <div class="call-modal" id="callModal">
        <div class="call-container">
            <div class="call-title" id="callTitle">–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í</div>
            <div id="callInfo" style="color: #ccc; margin-bottom: 20px;"></div>
            <div class="call-buttons">
                <button class="btn-accept" id="acceptCall">–ü–†–ò–ù–Ø–¢–¨</button>
                <button class="btn-reject" id="rejectCall">–û–¢–ö–õ–û–ù–ò–¢–¨</button>
                <button class="btn-end" id="endCall" style="display: none;">–ó–ê–í–ï–†–®–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="container" id="mainInterface" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="header-info">
                <h1>–û–ü–ï–†–ê–¢–ò–í–ù–´–ô –¶–ï–ù–¢–†</h1>
                <div style="color: #888; font-size: 0.9em;">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª #ALPHA</div>
            </div>
            <div class="header-stats">
                <div class="stat-badge" id="onlineCount">üë• 0</div>
                <div class="stat-badge" id="missionCount">üéØ 0</div>
                <div class="stat-badge" id="callStatus">üìû –°–í–û–ë–û–î–ï–ù</div>
            </div>
        </div>

        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
        <div class="panel">
            <div class="panel-header">–ö–û–ù–¢–ê–ö–¢–´</div>
            <div class="panel-content" id="contactsList">
                <div class="contact-item">
                    <div class="contact-codename">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="contact-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
                </div>
            </div>
        </div>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å - –ß–∞—Ç -->
        <div class="panel chat-area">
            <div class="panel-header">–û–ë–©–ò–ô –ö–ê–ù–ê–õ –°–í–Ø–ó–ò</div>
            <div class="messages" id="messages">
                <div class="message system">
                    <div class="message-header">
                        <span class="message-codename">–°–ò–°–¢–ï–ú–ê</span>
                        <span class="message-time" id="currentTime"></span>
                    </div>
                    <div class="message-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å–≤—è–∑–∏...</div>
                </div>
            </div>
            <div class="input-area">
                <input type="text" class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button class="send-button" id="sendButton" disabled>–û–¢–ü–†–ê–í–ò–¢–¨</button>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ó–∞–¥–∞–Ω–∏—è -->
        <div class="panel">
            <div class="panel-header">–û–ë–©–ò–ï –ó–ê–î–ê–ù–ò–Ø</div>
            <div class="panel-content" id="missionsList">
                <div class="mission-item">
                    <div class="mission-title">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π...</div>
                    <div class="mission-description">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        class OperationalCenter {
            constructor() {
                this.socket = null;
                this.currentUser = null;
                this.isConnected = false;
                this.currentCall = null;
                
                this.initializeElements();
                this.setupEventListeners();
                this.connectToServer();
                this.startClock();
            }

            initializeElements() {
                // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                this.loginModal = document.getElementById('loginModal');
                this.mainInterface = document.getElementById('mainInterface');
                this.callModal = document.getElementById('callModal');
                
                // –õ–æ–≥–∏–Ω
                this.usernameInput = document.getElementById('usernameInput');
                this.codenameInput = document.getElementById('codenameInput');
                this.joinButton = document.getElementById('joinButton');
                
                // –ß–∞—Ç
                this.messagesContainer = document.getElementById('messages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                
                // –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∑–∞–¥–∞–Ω–∏—è
                this.contactsList = document.getElementById('contactsList');
                this.missionsList = document.getElementById('missionsList');
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                this.onlineCount = document.getElementById('onlineCount');
                this.missionCount = document.getElementById('missionCount');
                this.callStatus = document.getElementById('callStatus');
                this.currentTime = document.getElementById('currentTime');
                
                // –ó–≤–æ–Ω–∫–∏
                this.callTitle = document.getElementById('callTitle');
                this.callInfo = document.getElementById('callInfo');
                this.acceptCall = document.getElementById('acceptCall');
                this.rejectCall = document.getElementById('rejectCall');
                this.endCall = document.getElementById('endCall');
            }

            setupEventListeners() {
                // –õ–æ–≥–∏–Ω
                this.joinButton.addEventListener('click', () => this.joinNetwork());
                this.usernameInput.addEventListener('keypress', (e) => e.key === 'Enter' && this.joinNetwork());
                this.codenameInput.addEventListener('keypress', (e) => e.key === 'Enter' && this.joinNetwork());

                // –ß–∞—Ç
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => e.key === 'Enter' && this.sendMessage());

                // –ó–≤–æ–Ω–∫–∏
                this.acceptCall.addEventListener('click', () => this.acceptCurrentCall());
                this.rejectCall.addEventListener('click', () => this.rejectCurrentCall());
                this.endCall.addEventListener('click', () => this.endCurrentCall());
            }

            connectToServer() {
                this.socket = io(window.location.origin);

                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateCallStatus('–°–í–û–ë–û–î–ï–ù', '#0f0');
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateCallStatus('–û–§–§–õ–ê–ô–ù', '#f00');
                    this.disableChat();
                });

                // –°–æ–æ–±—â–µ–Ω–∏—è
                this.socket.on('message_history', (messages) => {
                    this.displayMessageHistory(messages);
                });

                this.socket.on('new_message', (message) => {
                    this.displayMessage(message);
                    this.scrollToBottom();
                });

                this.socket.on('agent_joined', (data) => {
                    this.displaySystemMessage(data.message);
                });

                this.socket.on('agent_left', (data) => {
                    this.displaySystemMessage(data.message);
                });

                this.socket.on('online_agents', (agents) => {
                    this.updateContacts(agents);
                });

                // –ó–∞–¥–∞–Ω–∏—è
                this.socket.on('missions_update', (missions) => {
                    this.updateMissions(missions);
                });

                // –ó–≤–æ–Ω–∫–∏
                this.socket.on('incoming_call', (data) => {
                    this.showIncomingCall(data);
                });

                this.socket.on('call_initiated', (data) => {
                    this.showOutgoingCall(data);
                });

                this.socket.on('call_accepted', (data) => {
                    this.showCallConnected(data);
                });

                this.socket.on('call_connected', (data) => {
                    this.showActiveCall(data);
                });

                this.socket.on('call_rejected', (data) => {
                    this.showCallRejected(data);
                });

                this.socket.on('call_ended', (data) => {
                    this.showCallEnded(data);
                });

                this.socket.on('call_failed', (data) => {
                    alert(`–û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞: ${data.reason}`);
                    this.hideCallModal();
                });
            }

            joinNetwork() {
                const username = this.usernameInput.value.trim();
                const codename = this.codenameInput.value.trim() || '–ê–≥–µ–Ω—Ç';

                if (!username) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                    return;
                }

                this.currentUser = { username, codename };
                this.socket.emit('user_join', this.currentUser);
                
                this.loginModal.style.display = 'none';
                this.mainInterface.style.display = 'grid';
                this.enableChat();
                
                this.displaySystemMessage(`–í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–º—É —Ü–µ–Ω—Ç—Ä—É –∫–∞–∫ ${codename}`);
            }

            sendMessage() {
                const text = this.messageInput.value.trim();
                if (!text || !this.isConnected) return;

                this.socket.emit('send_message', { text });
                this.messageInput.value = '';
            }

            // –ö–æ–Ω—Ç–∞–∫—Ç—ã
            updateContacts(agents) {
                this.contactsList.innerHTML = '';
                this.onlineCount.textContent = `üë• ${agents.length}`;
                
                if (agents.length === 0) {
                    this.contactsList.innerHTML = '<div class="contact-item">–ê–≥–µ–Ω—Ç–æ–≤ –Ω–µ—Ç –≤ —Å–µ—Ç–∏</div>';
                    return;
                }
                
                agents.forEach(agent => {
                    if (agent.codename === this.currentUser.codename) return;
                    
                    const contactElement = document.createElement('div');
                    contactElement.className = `contact-item ${agent.isInCall ? 'in-call' : ''}`;
                    contactElement.innerHTML = `
                        <div class="contact-codename">${this.escapeHtml(agent.codename)}</div>
                        <div class="contact-status ${agent.isInCall ? 'in-call' : 'online'}">
                            ${agent.isInCall ? 'üìû –í –∑–≤–æ–Ω–∫–µ' : 'üü¢ –í —Å–µ—Ç–∏'}
                        </div>
                        <div class="contact-actions">
                            <button class="btn-call" onclick="messenger.callAgent('${this.escapeHtml(agent.codename)}')">
                                üìû –í—ã–∑–æ–≤
                            </button>
                            <button class="btn-message" onclick="messenger.focusChat()">
                                ‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ
                            </button>
                        </div>
                    `;
                    this.contactsList.appendChild(contactElement);
                });
            }

            // –ó–∞–¥–∞–Ω–∏—è
            updateMissions(missions) {
                this.missionsList.innerHTML = '';
                this.missionCount.textContent = `üéØ ${missions.filter(m => m.status === 'active').length}`;
                
                missions.forEach(mission => {
                    const missionElement = document.createElement('div');
                    missionElement.className = `mission-item ${mission.priority}`;
                    missionElement.innerHTML = `
                        <div class="mission-title">${this.escapeHtml(mission.title)}</div>
                        <div class="mission-description">${this.escapeHtml(mission.description)}</div>
                        <div class="mission-meta">
                            <span>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${mission.priority}</span>
                            <span class="mission-assigned">${mission.assignedTo.length} –∞–≥–µ–Ω—Ç–æ–≤</span>
                        </div>
                        ${mission.status === 'active' ? `
                            <button class="btn-assign" onclick="messenger.assignMission('${mission.id}')">
                                –í–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                            </button>
                        ` : `
                            <button class="btn-complete" disabled>
                                ‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                            </button>
                        `}
                    `;
                    this.missionsList.appendChild(missionElement);
                });
            }

            // –ó–≤–æ–Ω–∫–∏
            callAgent(codename) {
                if (this.currentCall) {
                    alert('–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –∑–≤–æ–Ω–æ–∫ –ø—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π');
                    return;
                }
                
                this.socket.emit('call_user', { targetCodename: codename });
            }

            showIncomingCall(data) {
                this.currentCall = { type: 'incoming', data };
                this.callTitle.textContent = 'üìû –í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í';
                this.callInfo.textContent = `–ê–≥–µ–Ω—Ç ${data.callerCodename} –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∞—Å`;
                this.acceptCall.style.display = 'block';
                this.rejectCall.style.display = 'block';
                this.endCall.style.display = 'none';
                this.callModal.style.display = 'flex';
                this.updateCallStatus('–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í', '#ffaa00');
            }

            showOutgoingCall(data) {
                this.currentCall = { type: 'outgoing', data };
                this.callTitle.textContent = 'üìû –í–´–ó–û–í...';
                this.callInfo.textContent = `–í—ã–∑–æ–≤ –∞–≥–µ–Ω—Ç—É ${data.targetCodename}`;
                this.acceptCall.style.display = 'none';
                this.rejectCall.style.display = 'block';
                this.rejectCall.textContent = '–û–¢–ú–ï–ù–ê';
                this.endCall.style.display = 'none';
                this.callModal.style.display = 'flex';
                this.updateCallStatus('–í–´–ó–û–í...', '#ffaa00');
            }

            showCallConnected(data) {
                this.callTitle.textContent = 'üìû –ó–í–û–ù–û–ö –ê–ö–¢–ò–í–ï–ù';
                this.callInfo.textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∞–≥–µ–Ω—Ç–æ–º ${data.targetCodename} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`;
                this.updateCallStatus('–í –ó–í–û–ù–ö–ï', '#ff4444');
            }

            showActiveCall(data) {
                this.acceptCall.style.display = 'none';
                this.rejectCall.style.display = 'none';
                this.endCall.style.display = 'block';
                this.updateCallStatus('–í –ó–í–û–ù–ö–ï', '#ff4444');
            }

            showCallRejected(data) {
                alert(`–ê–≥–µ–Ω—Ç ${data.targetCodename} –æ—Ç–∫–ª–æ–Ω–∏–ª –≤—ã–∑–æ–≤`);
                this.hideCallModal();
            }

            showCallEnded(data) {
                alert(`–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω: ${data.reason}`);
                this.hideCallModal();
            }

            acceptCurrentCall() {
                this.socket.emit('accept_call', {});
                this.showActiveCall();
            }

            rejectCurrentCall() {
                this.socket.emit(this.currentCall.type === 'incoming' ? 'reject_call' : 'end_call', {});
                this.hideCallModal();
            }

            endCurrentCall() {
                this.socket.emit('end_call', {});
                this.hideCallModal();
            }

            hideCallModal() {
                this.callModal.style.display = 'none';
                this.currentCall = null;
                this.updateCallStatus('–°–í–û–ë–û–î–ï–ù', '#0f0');
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            assignMission(missionId) {
                this.socket.emit('assign_mission', {
                    missionId: missionId,
                    codename: this.currentUser.codename
                });
            }

            focusChat() {
                this.messageInput.focus();
            }

            updateCallStatus(text, color) {
                this.callStatus.textContent = `üìû ${text}`;
                this.callStatus.style.color = color;
            }

            displayMessage(message) {
                const messageElement = document.createElement('div');
                const isOwn = message.userId === this.socket.id;
                const isSystem = message.type === 'system';
                
                messageElement.className = `message ${isSystem ? 'system' : isOwn ? 'own' : ''}`;
                
                const time = new Date(message.timestamp).toLocaleTimeString();
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="message-codename">${this.escapeHtml(message.codename)}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${this.escapeHtml(message.text)}</div>
                `;
                
                this.messagesContainer.appendChild(messageElement);
            }

            displayMessageHistory(messages) {
                const systemMessages = this.messagesContainer.querySelectorAll('.message.system');
                systemMessages.forEach(msg => msg.remove());
                
                messages.forEach(message => this.displayMessage(message));
                this.scrollToBottom();
            }

            displaySystemMessage(text) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message system';
                
                const time = new Date().toLocaleTimeString();
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="message-codename">–°–ò–°–¢–ï–ú–ê</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${this.escapeHtml(text)}</div>
                `;
                
                this.messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
            }

            enableChat() {
                this.messageInput.disabled = false;
                this.sendButton.disabled = false;
                this.messageInput.focus();
            }

            disableChat() {
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            startClock() {
                setInterval(() => {
                    const now = new Date();
                    this.currentTime.textContent = now.toLocaleTimeString();
                }, 1000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        let messenger;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            messenger = new OperationalCenter();
        });
    </script>
</body>
</html>
