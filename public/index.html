<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оперативный центр</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0c0c0c;
            color: #00ff00;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* CRT эффект */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: #1a1a1a;
            padding: 20px;
            border: 1px solid #333;
            margin-bottom: 20px;
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info h1 {
            font-size: 1.8em;
            font-weight: 300;
            color: #00ff00;
            margin-bottom: 5px;
            text-shadow: 0 0 10px #00ff00;
        }

        .header-stats {
            display: flex;
            gap: 20px;
        }

        .stat-badge {
            background: #0c0c0c;
            padding: 8px 15px;
            border: 1px solid #333;
            color: #0f0;
            font-size: 0.9em;
        }

        /* Панели */
        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #0c0c0c;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            color: #0f0;
            font-weight: bold;
        }

        .panel-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        /* Контакты */
        .contact-item {
            background: #0c0c0c;
            padding: 12px 15px;
            margin: 8px 0;
            border: 1px solid #333;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .contact-item:hover {
            border-color: #0f0;
            background: #252525;
        }

        .contact-item.in-call {
            border-color: #ff4444;
            background: #2a1a1a;
        }

        .contact-codename {
            color: #fff;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .contact-status {
            font-size: 0.8em;
            color: #666;
        }

        .contact-status.online {
            color: #0f0;
        }

        .contact-status.in-call {
            color: #ff4444;
        }

        .contact-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .btn-call, .btn-message {
            padding: 4px 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #0f0;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .btn-call:hover {
            background: #0f0;
            color: #000;
        }

        .btn-message:hover {
            background: #00aaff;
            color: #000;
        }

        /* Задания */
        .mission-item {
            background: #0c0c0c;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #333;
            border-left: 4px solid #333;
        }

        .mission-item.high {
            border-left-color: #ff4444;
        }

        .mission-item.medium {
            border-left-color: #ffaa00;
        }

        .mission-item.low {
            border-left-color: #00ff00;
        }

        .mission-title {
            color: #fff;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .mission-description {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .mission-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: #666;
        }

        .mission-assigned {
            color: #0f0;
        }

        .btn-assign, .btn-complete {
            padding: 4px 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #0f0;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 8px;
        }

        .btn-complete {
            background: #0f0;
            color: #000;
        }

        /* Чат */
        .chat-area {
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #0c0c0c;
            border-bottom: 1px solid #333;
            max-height: 500px;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 12px;
            border-left: 3px solid #333;
            background: #1a1a1a;
            transition: all 0.3s ease;
        }

        .message:hover {
            border-left-color: #0f0;
            background: #252525;
        }

        .message.system {
            border-left-color: #ff4444;
            background: #2a1a1a;
        }

        .message.own {
            border-left-color: #00aaff;
            background: #1a1a2a;
        }

        .message-header {
            font-size: 0.8em;
            margin-bottom: 5px;
            color: #888;
        }

        .message-codename {
            color: #0f0;
            font-weight: bold;
        }

        .message-time {
            color: #666;
            float: right;
        }

        .message-text {
            color: #ccc;
            word-wrap: break-word;
        }

        .input-area {
            padding: 15px;
            background: #1a1a1a;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 10px 12px;
            background: #0c0c0c;
            border: 1px solid #333;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
        }

        .message-input:focus {
            border-color: #0f0;
            box-shadow: 0 0 10px #00ff00;
        }

        .send-button {
            padding: 10px 20px;
            background: #0c0c0c;
            border: 1px solid #333;
            color: #0f0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background: #0f0;
            color: #000;
        }

        /* Звонок */
        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .call-container {
            background: #1a1a1a;
            padding: 30px;
            border: 2px solid #0f0;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        .call-title {
            color: #0f0;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .call-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-accept, .btn-reject, .btn-end {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 1em;
        }

        .btn-accept {
            background: #0f0;
            color: #000;
        }

        .btn-reject, .btn-end {
            background: #f00;
            color: #fff;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-form {
            background: #1a1a1a;
            padding: 40px;
            border: 1px solid #333;
            width: 90%;
            max-width: 400px;
        }

        .login-title {
            color: #0f0;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #0c0c0c;
            border: 1px solid #333;
            color: #0f0;
            font-family: 'Courier New', monospace;
        }

        .join-button {
            width: 100%;
            padding: 12px;
            background: #0c0c0c;
            border: 1px solid #333;
            color: #0f0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0f0;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .panel {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Модальное окно входа -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2 class="login-title">🕵️ ДОСТУП К ОПЕРАТИВНОМУ ЦЕНТРУ</h2>
            <input type="text" class="login-input" id="usernameInput" placeholder="Ваше имя" maxlength="20">
            <input type="text" class="login-input" id="codenameInput" placeholder="Позывной" maxlength="15">
            <button class="join-button" id="joinButton">ПОДКЛЮЧИТЬСЯ</button>
        </div>
    </div>

    <!-- Модальное окно звонка -->
    <div class="call-modal" id="callModal">
        <div class="call-container">
            <div class="call-title" id="callTitle">ВХОДЯЩИЙ ВЫЗОВ</div>
            <div id="callInfo" style="color: #ccc; margin-bottom: 20px;"></div>
            <div class="call-buttons">
                <button class="btn-accept" id="acceptCall">ПРИНЯТЬ</button>
                <button class="btn-reject" id="rejectCall">ОТКЛОНИТЬ</button>
                <button class="btn-end" id="endCall" style="display: none;">ЗАВЕРШИТЬ</button>
            </div>
        </div>
    </div>

    <!-- Основной интерфейс -->
    <div class="container" id="mainInterface" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="header-info">
                <h1>ОПЕРАТИВНЫЙ ЦЕНТР</h1>
                <div style="color: #888; font-size: 0.9em;">Зашифрованный канал #ALPHA</div>
            </div>
            <div class="header-stats">
                <div class="stat-badge" id="onlineCount">👥 0</div>
                <div class="stat-badge" id="missionCount">🎯 0</div>
                <div class="stat-badge" id="callStatus">📞 СВОБОДЕН</div>
            </div>
        </div>

        <!-- Левая панель - Контакты -->
        <div class="panel">
            <div class="panel-header">КОНТАКТЫ</div>
            <div class="panel-content" id="contactsList">
                <div class="contact-item">
                    <div class="contact-codename">Загрузка...</div>
                    <div class="contact-status">Подключение...</div>
                </div>
            </div>
        </div>

        <!-- Центральная панель - Чат -->
        <div class="panel chat-area">
            <div class="panel-header">ОБЩИЙ КАНАЛ СВЯЗИ</div>
            <div class="messages" id="messages">
                <div class="message system">
                    <div class="message-header">
                        <span class="message-codename">СИСТЕМА</span>
                        <span class="message-time" id="currentTime"></span>
                    </div>
                    <div class="message-text">Инициализация защищенного канала связи...</div>
                </div>
            </div>
            <div class="input-area">
                <input type="text" class="message-input" id="messageInput" placeholder="Введите сообщение..." disabled>
                <button class="send-button" id="sendButton" disabled>ОТПРАВИТЬ</button>
            </div>
        </div>

        <!-- Правая панель - Задания -->
        <div class="panel">
            <div class="panel-header">ОБЩИЕ ЗАДАНИЯ</div>
            <div class="panel-content" id="missionsList">
                <div class="mission-item">
                    <div class="mission-title">Загрузка заданий...</div>
                    <div class="mission-description">Подключение к серверу...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        class OperationalCenter {
            constructor() {
                this.socket = null;
                this.currentUser = null;
                this.isConnected = false;
                this.currentCall = null;
                
                this.initializeElements();
                this.setupEventListeners();
                this.connectToServer();
                this.startClock();
            }

            initializeElements() {
                // Модальные окна
                this.loginModal = document.getElementById('loginModal');
                this.mainInterface = document.getElementById('mainInterface');
                this.callModal = document.getElementById('callModal');
                
                // Логин
                this.usernameInput = document.getElementById('usernameInput');
                this.codenameInput = document.getElementById('codenameInput');
                this.joinButton = document.getElementById('joinButton');
                
                // Чат
                this.messagesContainer = document.getElementById('messages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                
                // Контакты и задания
                this.contactsList = document.getElementById('contactsList');
                this.missionsList = document.getElementById('missionsList');
                
                // Статистика
                this.onlineCount = document.getElementById('onlineCount');
                this.missionCount = document.getElementById('missionCount');
                this.callStatus = document.getElementById('callStatus');
                this.currentTime = document.getElementById('currentTime');
                
                // Звонки
                this.callTitle = document.getElementById('callTitle');
                this.callInfo = document.getElementById('callInfo');
                this.acceptCall = document.getElementById('acceptCall');
                this.rejectCall = document.getElementById('rejectCall');
                this.endCall = document.getElementById('endCall');
            }

            setupEventListeners() {
                // Логин
                this.joinButton.addEventListener('click', () => this.joinNetwork());
                this.usernameInput.addEventListener('keypress', (e) => e.key === 'Enter' && this.joinNetwork());
                this.codenameInput.addEventListener('keypress', (e) => e.key === 'Enter' && this.joinNetwork());

                // Чат
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => e.key === 'Enter' && this.sendMessage());

                // Звонки
                this.acceptCall.addEventListener('click', () => this.acceptCurrentCall());
                this.rejectCall.addEventListener('click', () => this.rejectCurrentCall());
                this.endCall.addEventListener('click', () => this.endCurrentCall());
            }

            connectToServer() {
                this.socket = io(window.location.origin);

                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateCallStatus('СВОБОДЕН', '#0f0');
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateCallStatus('ОФФЛАЙН', '#f00');
                    this.disableChat();
                });

                // Сообщения
                this.socket.on('message_history', (messages) => {
                    this.displayMessageHistory(messages);
                });

                this.socket.on('new_message', (message) => {
                    this.displayMessage(message);
                    this.scrollToBottom();
                });

                this.socket.on('agent_joined', (data) => {
                    this.displaySystemMessage(data.message);
                });

                this.socket.on('agent_left', (data) => {
                    this.displaySystemMessage(data.message);
                });

                this.socket.on('online_agents', (agents) => {
                    this.updateContacts(agents);
                });

                // Задания
                this.socket.on('missions_update', (missions) => {
                    this.updateMissions(missions);
                });

                // Звонки
                this.socket.on('incoming_call', (data) => {
                    this.showIncomingCall(data);
                });

                this.socket.on('call_initiated', (data) => {
                    this.showOutgoingCall(data);
                });

                this.socket.on('call_accepted', (data) => {
                    this.showCallConnected(data);
                });

                this.socket.on('call_connected', (data) => {
                    this.showActiveCall(data);
                });

                this.socket.on('call_rejected', (data) => {
                    this.showCallRejected(data);
                });

                this.socket.on('call_ended', (data) => {
                    this.showCallEnded(data);
                });

                this.socket.on('call_failed', (data) => {
                    alert(`Ошибка звонка: ${data.reason}`);
                    this.hideCallModal();
                });
            }

            joinNetwork() {
                const username = this.usernameInput.value.trim();
                const codename = this.codenameInput.value.trim() || 'Агент';

                if (!username) {
                    alert('Введите ваше имя');
                    return;
                }

                this.currentUser = { username, codename };
                this.socket.emit('user_join', this.currentUser);
                
                this.loginModal.style.display = 'none';
                this.mainInterface.style.display = 'grid';
                this.enableChat();
                
                this.displaySystemMessage(`Вы подключились к оперативному центру как ${codename}`);
            }

            sendMessage() {
                const text = this.messageInput.value.trim();
                if (!text || !this.isConnected) return;

                this.socket.emit('send_message', { text });
                this.messageInput.value = '';
            }

            // Контакты
            updateContacts(agents) {
                this.contactsList.innerHTML = '';
                this.onlineCount.textContent = `👥 ${agents.length}`;
                
                if (agents.length === 0) {
                    this.contactsList.innerHTML = '<div class="contact-item">Агентов нет в сети</div>';
                    return;
                }
                
                agents.forEach(agent => {
                    if (agent.codename === this.currentUser.codename) return;
                    
                    const contactElement = document.createElement('div');
                    contactElement.className = `contact-item ${agent.isInCall ? 'in-call' : ''}`;
                    contactElement.innerHTML = `
                        <div class="contact-codename">${this.escapeHtml(agent.codename)}</div>
                        <div class="contact-status ${agent.isInCall ? 'in-call' : 'online'}">
                            ${agent.isInCall ? '📞 В звонке' : '🟢 В сети'}
                        </div>
                        <div class="contact-actions">
                            <button class="btn-call" onclick="messenger.callAgent('${this.escapeHtml(agent.codename)}')">
                                📞 Вызов
                            </button>
                            <button class="btn-message" onclick="messenger.focusChat()">
                                ✉️ Сообщение
                            </button>
                        </div>
                    `;
                    this.contactsList.appendChild(contactElement);
                });
            }

            // Задания
            updateMissions(missions) {
                this.missionsList.innerHTML = '';
                this.missionCount.textContent = `🎯 ${missions.filter(m => m.status === 'active').length}`;
                
                missions.forEach(mission => {
                    const missionElement = document.createElement('div');
                    missionElement.className = `mission-item ${mission.priority}`;
                    missionElement.innerHTML = `
                        <div class="mission-title">${this.escapeHtml(mission.title)}</div>
                        <div class="mission-description">${this.escapeHtml(mission.description)}</div>
                        <div class="mission-meta">
                            <span>Приоритет: ${mission.priority}</span>
                            <span class="mission-assigned">${mission.assignedTo.length} агентов</span>
                        </div>
                        ${mission.status === 'active' ? `
                            <button class="btn-assign" onclick="messenger.assignMission('${mission.id}')">
                                Взять задание
                            </button>
                        ` : `
                            <button class="btn-complete" disabled>
                                ✓ Выполнено
                            </button>
                        `}
                    `;
                    this.missionsList.appendChild(missionElement);
                });
            }

            // Звонки
            callAgent(codename) {
                if (this.currentCall) {
                    alert('Завершите текущий звонок прежде чем начать новый');
                    return;
                }
                
                this.socket.emit('call_user', { targetCodename: codename });
            }

            showIncomingCall(data) {
                this.currentCall = { type: 'incoming', data };
                this.callTitle.textContent = '📞 ВХОДЯЩИЙ ВЫЗОВ';
                this.callInfo.textContent = `Агент ${data.callerCodename} вызывает вас`;
                this.acceptCall.style.display = 'block';
                this.rejectCall.style.display = 'block';
                this.endCall.style.display = 'none';
                this.callModal.style.display = 'flex';
                this.updateCallStatus('ВХОДЯЩИЙ ВЫЗОВ', '#ffaa00');
            }

            showOutgoingCall(data) {
                this.currentCall = { type: 'outgoing', data };
                this.callTitle.textContent = '📞 ВЫЗОВ...';
                this.callInfo.textContent = `Вызов агенту ${data.targetCodename}`;
                this.acceptCall.style.display = 'none';
                this.rejectCall.style.display = 'block';
                this.rejectCall.textContent = 'ОТМЕНА';
                this.endCall.style.display = 'none';
                this.callModal.style.display = 'flex';
                this.updateCallStatus('ВЫЗОВ...', '#ffaa00');
            }

            showCallConnected(data) {
                this.callTitle.textContent = '📞 ЗВОНОК АКТИВЕН';
                this.callInfo.textContent = `Соединение с агентом ${data.targetCodename} установлено`;
                this.updateCallStatus('В ЗВОНКЕ', '#ff4444');
            }

            showActiveCall(data) {
                this.acceptCall.style.display = 'none';
                this.rejectCall.style.display = 'none';
                this.endCall.style.display = 'block';
                this.updateCallStatus('В ЗВОНКЕ', '#ff4444');
            }

            showCallRejected(data) {
                alert(`Агент ${data.targetCodename} отклонил вызов`);
                this.hideCallModal();
            }

            showCallEnded(data) {
                alert(`Звонок завершен: ${data.reason}`);
                this.hideCallModal();
            }

            acceptCurrentCall() {
                this.socket.emit('accept_call', {});
                this.showActiveCall();
            }

            rejectCurrentCall() {
                this.socket.emit(this.currentCall.type === 'incoming' ? 'reject_call' : 'end_call', {});
                this.hideCallModal();
            }

            endCurrentCall() {
                this.socket.emit('end_call', {});
                this.hideCallModal();
            }

            hideCallModal() {
                this.callModal.style.display = 'none';
                this.currentCall = null;
                this.updateCallStatus('СВОБОДЕН', '#0f0');
            }

            // Вспомогательные методы
            assignMission(missionId) {
                this.socket.emit('assign_mission', {
                    missionId: missionId,
                    codename: this.currentUser.codename
                });
            }

            focusChat() {
                this.messageInput.focus();
            }

            updateCallStatus(text, color) {
                this.callStatus.textContent = `📞 ${text}`;
                this.callStatus.style.color = color;
            }

            displayMessage(message) {
                const messageElement = document.createElement('div');
                const isOwn = message.userId === this.socket.id;
                const isSystem = message.type === 'system';
                
                messageElement.className = `message ${isSystem ? 'system' : isOwn ? 'own' : ''}`;
                
                const time = new Date(message.timestamp).toLocaleTimeString();
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="message-codename">${this.escapeHtml(message.codename)}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${this.escapeHtml(message.text)}</div>
                `;
                
                this.messagesContainer.appendChild(messageElement);
            }

            displayMessageHistory(messages) {
                const systemMessages = this.messagesContainer.querySelectorAll('.message.system');
                systemMessages.forEach(msg => msg.remove());
                
                messages.forEach(message => this.displayMessage(message));
                this.scrollToBottom();
            }

            displaySystemMessage(text) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message system';
                
                const time = new Date().toLocaleTimeString();
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="message-codename">СИСТЕМА</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${this.escapeHtml(text)}</div>
                `;
                
                this.messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
            }

            enableChat() {
                this.messageInput.disabled = false;
                this.sendButton.disabled = false;
                this.messageInput.focus();
            }

            disableChat() {
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            startClock() {
                setInterval(() => {
                    const now = new Date();
                    this.currentTime.textContent = now.toLocaleTimeString();
                }, 1000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Глобальная переменная для доступа из HTML
        let messenger;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', () => {
            messenger = new OperationalCenter();
        });
    </script>
</body>
</html>
