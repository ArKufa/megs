<script src="/socket.io/socket.io.js"></script>
<script>
    let socket;
    let currentUsername = '';
    let isConnected = false;

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    function updateStatus(connected) {
        const status = document.getElementById('status');
        isConnected = connected;
        if (connected) {
            status.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
            status.className = 'status';
        } else {
            status.textContent = '‚ùå –û—Ñ–ª–∞–π–Ω';
            status.className = 'status offline';
        }
    }

    function login() {
        const usernameInput = document.getElementById('usernameInput');
        const username = usernameInput.value.trim();
        
        if (username.length < 2) {
            showError('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
            return;
        }

        currentUsername = username;
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('chatContainer').style.display = 'flex';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.io
        initializeSocket();
    }

    function initializeSocket() {
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ç–æ–º—É –∂–µ –¥–æ–º–µ–Ω—É, –≥–¥–µ —Ä–∞–∑–º–µ—â–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        socket = io({
            transports: ['websocket', 'polling']
        });

        socket.on('connect', () => {
            console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            updateStatus(true);
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            socket.emit('get_history');
        });

        socket.on('disconnect', () => {
            console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            updateStatus(false);
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        socket.on('message_history', (messages) => {
            console.log('üì® –ü–æ–ª—É—á–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è:', messages.length, '—Å–æ–æ–±—â–µ–Ω–∏–π');
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            messages.forEach(message => addMessageToChat(message));
        });

        // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        socket.on('new_message', (message) => {
            console.log('üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
            addMessageToChat(message);
        });

        // –û—à–∏–±–∫–∏
        socket.on('error', (error) => {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error);
            showError(error);
        });

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && isConnected) {
                sendMessage();
            }
        });
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();
        
        if (content && socket && isConnected) {
            socket.emit('send_message', {
                username: currentUsername,
                content: content
            });
            messageInput.value = '';
        } else {
            showError('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
        }
    }

    function addMessageToChat(message) {
        const container = document.getElementById('messagesContainer');
        const messageDiv = document.createElement('div');
        
        const messageType = message.username === currentUsername ? 'own' : 
                          message.username === 'system' ? 'system' : 'other';
        
        messageDiv.className = `message ${messageType}`;
        
        const timestamp = new Date(message.created_at).toLocaleTimeString('ru-RU');
        
        let messageHTML = '';
        if (message.username !== 'system') {
            messageHTML = `
                <div class="message-header">${message.username}</div>
                <div>${message.content}</div>
                <div class="message-time">${timestamp}</div>
            `;
        } else {
            messageHTML = `<div>${message.content}</div>`;
        }
        
        messageDiv.innerHTML = messageHTML;
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }

    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
    document.getElementById('usernameInput').focus();

    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
</script>
