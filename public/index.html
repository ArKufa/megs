<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .messenger-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 15px;
            background: #27ae60;
        }

        .status.offline {
            background: #e74c3c;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.other {
            background: white;
            border: 1px solid #e0e0e0;
        }

        .message.system {
            background: #ffc107;
            color: black;
            text-align: center;
            max-width: 100%;
            font-style: italic;
            margin: 10px auto;
        }

        .message-header {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .message-time {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ */
        .message-status {
            font-size: 0.7em;
            opacity: 0.7;
            margin-left: 5px;
        }

        .message-reply {
            background: rgba(0,0,0,0.05);
            border-left: 3px solid #007bff;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .message-actions {
            position: absolute;
            right: 10px;
            top: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 12px;
            color: #666;
        }

        .message-action:hover {
            color: #007bff;
        }

        .typing-indicator {
            padding: 10px 20px;
            color: #666;
            font-style: italic;
            font-size: 0.9em;
        }

        .online-users {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .online-user {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin: 2px;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #007bff;
        }

        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .login-container {
            text-align: center;
            padding: 40px;
        }

        .username-input {
            margin: 20px 0;
            padding: 12px;
            width: 80%;
            max-width: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 10px;
            margin: 10px 20px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <div class="messenger-container">
        <div class="header">
            <h1>üí¨ Browser Messenger</h1>
            <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>

        <!-- –ë–ª–æ–∫ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="online-users" id="onlineUsers" style="display: none;">
            <strong>–û–Ω–ª–∞–π–Ω:</strong>
            <div id="usersList"></div>
        </div>
        
        <div id="loginContainer" class="login-container">
            <h2>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è</h2>
            <input type="text" id="usernameInput" class="username-input" 
                   placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" autocomplete="off">
            <button onclick="login()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
        </div>

        <div id="chatContainer" style="display: none; height: 100%; flex-direction: column;">
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ -->
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <span id="typingUser">–ö—Ç–æ-—Ç–æ</span> –ø–µ—á–∞—Ç–∞–µ—Ç...
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="messages-container" id="messagesContainer">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       maxlength="500" autocomplete="off" disabled>
                <button onclick="sendMessage()" id="sendButton" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <textarea id="editText" style="width: 100%; height: 100px; margin: 10px 0; padding: 10px;"></textarea>
            <div style="text-align: right;">
                <button onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveEdit()" style="background: #007bff;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let currentUsername = '';
        let isConnected = false;
        let users = [];
        let editingMessageId = null;
        let typingTimer;

        // Telegram —Ñ—É–Ω–∫—Ü–∏–∏

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            isConnected = connected;
            if (connected) {
                status.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
                status.className = 'status';
            } else {
                status.textContent = '‚ùå –û—Ñ–ª–∞–π–Ω';
                status.className = 'status offline';
            }
        }

        function login() {
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            
            if (username.length < 2) {
                showError('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
                return;
            }

            currentUsername = username;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('onlineUsers').style.display = 'block';

            initializeSocket();
        }

        function initializeSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                updateStatus(true);
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                
                // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                socket.emit('user_join', currentUsername);
                
                socket.emit('get_history');
            });

            socket.on('disconnect', () => {
                console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                updateStatus(false);
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendButton').disabled = true;
            });

            // –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            socket.on('message_history', (messages) => {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                messages.forEach(message => addMessageToChat(message));
            });

            // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            socket.on('new_message', (message) => {
                addMessageToChat(message);
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            socket.on('users_update', (usersList) => {
                updateUsersList(usersList);
            });

            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç
            socket.on('user_typing', (data) => {
                showTypingIndicator(data.username);
            });

            socket.on('user_stop_typing', () => {
                hideTypingIndicator();
            });

            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
            socket.on('message_edited', (message) => {
                updateMessage(message);
            });

            // –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
            socket.on('message_deleted', (data) => {
                if (data.deletedFor === 'everyone' || 
                   (data.deletedFor === 'me' && data.messageId === editingMessageId)) {
                    deleteMessage(data.messageId);
                }
            });

            // –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ
            socket.on('message_read', (data) => {
                updateMessageStatus(data.messageId, 'read');
            });

            // –û—à–∏–±–∫–∏
            socket.on('error', (error) => {
                showError(error);
            });

            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && isConnected) {
                    sendMessage();
                }
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
                handleTyping();
            });

            document.getElementById('messageInput').addEventListener('input', handleTyping);
        }

        function handleTyping() {
            if (socket && isConnected) {
                socket.emit('typing', { chatId: 'general' });
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    socket.emit('stop_typing');
                }, 1000);
            }
        }

        function showTypingIndicator(username) {
            if (username !== currentUsername) {
                document.getElementById('typingUser').textContent = username;
                document.getElementById('typingIndicator').style.display = 'block';
                
                setTimeout(() => {
                    hideTypingIndicator();
                }, 3000);
            }
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (content && socket && isConnected) {
                socket.emit('send_message', {
                    username: currentUsername,
                    content: content
                });
                messageInput.value = '';
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
                socket.emit('stop_typing');
                clearTimeout(typingTimer);
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function editMessage(messageId, currentContent) {
            editingMessageId = messageId;
            document.getElementById('editText').value = currentContent;
            document.getElementById('editModal').style.display = 'block';
        }

        function cancelEdit() {
            document.getElementById('editModal').style.display = 'none';
            editingMessageId = null;
        }

        function saveEdit() {
            const newContent = document.getElementById('editText').value.trim();
            if (newContent && editingMessageId) {
                socket.emit('edit_message', {
                    messageId: editingMessageId,
                    newContent: newContent
                });
                cancelEdit();
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function deleteMessage(messageId, forEveryone = false) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                socket.emit('delete_message', {
                    messageId: messageId,
                    forEveryone: forEveryone
                });
            }
        }

        // –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
        function replyToMessage(messageId, username, content) {
            const replyText = `@${username} ${content}`;
            document.getElementById('messageInput').value = replyText;
            document.getElementById('messageInput').focus();
            
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É reply
            socket.emit('send_reply', {
                username: currentUsername,
                content: document.getElementById('messageInput').value,
                replyTo: messageId
            });
        }

        function addMessageToChat(message) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            
            const messageType = message.username === currentUsername ? 'own' : 
                              message.username === 'system' ? 'system' : 'other';
            
            messageDiv.className = `message ${messageType}`;
            messageDiv.id = `message-${message.id}`;
            
            const timestamp = new Date(message.created_at).toLocaleTimeString('ru-RU');
            
            let messageHTML = '';
            if (message.username !== 'system') {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                const actions = messageType === 'own' ? `
                    <div class="message-actions">
                        <button class="message-action" onclick="editMessage('${message.id}', '${message.content.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                        <button class="message-action" onclick="deleteMessage('${message.id}', true)">üóëÔ∏è</button>
                    </div>
                ` : `
                    <div class="message-actions">
                        <button class="message-action" onclick="replyToMessage('${message.id}', '${message.username}', '${message.content.replace(/'/g, "\\'")}')">‚Ü©Ô∏è</button>
                    </div>
                `;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º reply –µ—Å–ª–∏ –µ—Å—Ç—å
                const replySection = message.reply_to_message ? `
                    <div class="message-reply">
                        <strong>${message.reply_to_message.username}:</strong> 
                        ${message.reply_to_message.content}
                    </div>
                ` : '';

                messageHTML = `
                    ${actions}
                    <div class="message-header">${message.username}</div>
                    ${replySection}
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">
                        ${timestamp}
                        ${messageType === 'own' ? `<span class="message-status">${message.status || 'sent'}</span>` : ''}
                        ${message.edited_at ? '<span style="font-style: italic;"> (—Ä–µ–¥.)</span>' : ''}
                    </div>
                `;
            } else {
                messageHTML = `<div class="message-content">${message.content}</div>`;
            }
            
            messageDiv.innerHTML = messageHTML;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function updateMessage(message) {
            const messageDiv = document.getElementById(`message-${message.id}`);
            if (messageDiv) {
                const contentDiv = messageDiv.querySelector('.message-content');
                if (contentDiv) {
                    contentDiv.textContent = message.content;
                }
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–º–µ—Ç–∫—É –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                const timeDiv = messageDiv.querySelector('.message-time');
                if (timeDiv && !timeDiv.innerHTML.includes('—Ä–µ–¥.')) {
                    timeDiv.innerHTML += ' <span style="font-style: italic;">(—Ä–µ–¥.)</span>';
                }
            }
        }

        function updateMessageStatus(messageId, status) {
            const messageDiv = document.getElementById(`message-${messageId}`);
            if (messageDiv) {
                const statusSpan = messageDiv.querySelector('.message-status');
                if (statusSpan) {
                    statusSpan.textContent = status;
                }
            }
        }

        function deleteMessage(messageId) {
            const messageDiv = document.getElementById(`message-${messageId}`);
            if (messageDiv) {
                messageDiv.remove();
            }
        }

        function updateUsersList(usersList) {
            const container = document.getElementById('usersList');
            users = usersList;
            
            container.innerHTML = '';
            
            users.forEach(user => {
                if (user.isOnline && user.username !== currentUsername) {
                    const userDiv = document.createElement('span');
                    userDiv.className = 'online-user';
                    userDiv.textContent = user.username;
                    container.appendChild(userDiv);
                }
            });
        }

        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
        document.getElementById('usernameInput').focus();

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                cancelEdit();
            }
        }
    </script>
</body>
</html>
