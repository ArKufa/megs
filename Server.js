const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');
const { createClient } = require('@supabase/supabase-js');
const bcrypt = require('bcryptjs');

const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

app.use(cors());
app.use(express.json());

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Supabase
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð² Ð¿Ð°Ð¼ÑÑ‚Ð¸
const onlineUsers = new Map();
const typingUsers = new Map();

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
async function initializeDatabase() {
  try {
    console.log('ðŸ”„ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…...');
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚
    const tables = [
      `CREATE TABLE IF NOT EXISTS users (
        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
        username TEXT UNIQUE NOT NULL,
        email TEXT UNIQUE,
        password TEXT NOT NULL,
        avatar TEXT DEFAULT 'ðŸ‘¤',
        status TEXT DEFAULT 'Ð’ ÑÐµÑ‚Ð¸',
        level INTEGER DEFAULT 1,
        experience INTEGER DEFAULT 0,
        registration_date TIMESTAMPTZ DEFAULT NOW(),
        last_seen TIMESTAMPTZ DEFAULT NOW()
      )`,
      
      `CREATE TABLE IF NOT EXISTS messages (
        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
        sender_id UUID REFERENCES users(id),
        receiver_id UUID,
        content TEXT NOT NULL,
        message_type TEXT DEFAULT 'text',
        is_read BOOLEAN DEFAULT false,
        created_at TIMESTAMPTZ DEFAULT NOW()
      )`,
      
      `CREATE TABLE IF NOT EXISTS friendships (
        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
        user_id UUID REFERENCES users(id),
        friend_id UUID REFERENCES users(id),
        status TEXT DEFAULT 'pending',
        created_at TIMESTAMPTZ DEFAULT NOW(),
        UNIQUE(user_id, friend_id)
      )`,
      
      `CREATE TABLE IF NOT EXISTS user_profiles (
        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
        user_id UUID REFERENCES users(id) UNIQUE,
        bio TEXT DEFAULT '',
        location TEXT DEFAULT '',
        website TEXT DEFAULT '',
        avatar_url TEXT DEFAULT ''
      )`
    ];

    for (const tableSql of tables) {
      const { error } = await supabase.rpc('exec_sql', { sql: tableSql });
      if (error && !error.message.includes('already exists')) {
        console.log('Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°:', error.message);
      }
    }

    console.log('âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°');
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹:', error);
  }
}

// Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.post('/api/register', async (req, res) => {
  try {
    const { username, email, password } = req.body;

    if (!username || !password) {
      return res.status(400).json({ error: 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });
    }

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const { data: existingUser } = await supabase
      .from('users')
      .select('id')
      .eq('username', username)
      .single();

    if (existingUser) {
      return res.status(400).json({ error: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚' });
    }

    // Ð¥ÐµÑˆÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
    const hashedPassword = await bcrypt.hash(password, 10);

    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const { data: user, error } = await supabase
      .from('users')
      .insert([
        {
          username,
          email: email || null,
          password: hashedPassword,
          avatar: getRandomAvatar(),
          status: 'Ð’ ÑÐµÑ‚Ð¸'
        }
      ])
      .select()
      .single();

    if (error) throw error;

    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ
    await supabase
      .from('user_profiles')
      .insert([{ user_id: user.id }]);

    const { password: _, ...userData } = user;
    res.json({ user: userData, message: 'Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°' });

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// Ð’Ñ…Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body;

    if (!username || !password) {
      return res.status(400).json({ error: 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ' });
    }

    // Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const { data: user, error } = await supabase
      .from('users')
      .select('*')
      .eq('username', username)
      .single();

    if (error || !user) {
      return res.status(401).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ' });
    }

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
    const validPassword = await bcrypt.compare(password, user.password);
    if (!validPassword) {
      return res.status(401).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ' });
    }

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ last_seen
    await supabase
      .from('users')
      .update({ last_seen: new Date().toISOString() })
      .eq('id', user.id);

    const { password: _, ...userData } = user;
    res.json({ user: userData, message: 'Ð’Ñ…Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½' });

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
app.get('/api/users/search', async (req, res) => {
  try {
    const { query } = req.query;
    
    const { data: users, error } = await supabase
      .from('users')
      .select('id, username, avatar, status, level')
      .ilike('username', `%${query}%`)
      .limit(20);

    if (error) throw error;

    res.json(users || []);
  } catch (error) {
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð¸ÑÐºÐ°' });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ñ€ÑƒÐ·ÐµÐ¹
app.get('/api/users/:userId/friends', async (req, res) => {
  try {
    const { userId } = req.params;

    const { data: friendships, error } = await supabase
      .from('friendships')
      .select(`
        id,
        status,
        friend:users!friendships_friend_id_fkey(id, username, avatar, status, level)
      `)
      .eq('user_id', userId)
      .eq('status', 'accepted');

    if (error) throw error;

    const friends = friendships.map(f => f.friend);
    res.json(friends);
  } catch (error) {
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ñ€ÑƒÐ·ÐµÐ¹' });
  }
});

// ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð´Ñ€ÑƒÐ¶Ð±Ñ‹
app.post('/api/friends/request', async (req, res) => {
  try {
    const { userId, friendId } = req.body;

    const { data: friendship, error } = await supabase
      .from('friendships')
      .insert([
        { user_id: userId, friend_id: friendId, status: 'pending' }
      ])
      .select()
      .single();

    if (error) throw error;

    res.json({ message: 'Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð´Ñ€ÑƒÐ¶Ð±Ñ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½', friendship });
  } catch (error) {
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°' });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
app.get('/api/messages/:userId/:friendId', async (req, res) => {
  try {
    const { userId, friendId } = req.params;

    const { data: messages, error } = await supabase
      .from('messages')
      .select('*')
      .or(`and(sender_id.eq.${userId},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${userId})`)
      .order('created_at', { ascending: true })
      .limit(100);

    if (error) throw error;

    res.json(messages || []);
  } catch (error) {
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹' });
  }
});

// Socket.io Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸
io.on('connection', (socket) => {
  console.log('ðŸ”— ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ:', socket.id);

  socket.on('user_online', async (userData) => {
    const user = {
      ...userData,
      socketId: socket.id,
      loginTime: new Date().toISOString()
    };

    onlineUsers.set(userData.id, user);
    socket.userId = userData.id;
    socket.username = userData.username;

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð² Ð±Ð°Ð·Ðµ
    await supabase
      .from('users')
      .update({ status: 'Ð’ ÑÐµÑ‚Ð¸', last_seen: new Date().toISOString() })
      .eq('id', userData.id);

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð½Ð»Ð°Ð¹Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
    io.emit('online_users_update', Array.from(onlineUsers.values()));

    console.log(`ðŸ‘¤ ${userData.username} Ð² ÑÐµÑ‚Ð¸`);
  });

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
  socket.on('send_private_message', async (data) => {
    try {
      const { receiverId, content, messageType = 'text' } = data;

      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð±Ð°Ð·Ñƒ
      const { data: message, error } = await supabase
        .from('messages')
        .insert([
          {
            sender_id: socket.userId,
            receiver_id: receiverId,
            content,
            message_type: messageType
          }
        ])
        .select()
        .single();

      if (error) throw error;

      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŽ ÐµÑÐ»Ð¸ Ð¾Ð½Ð»Ð°Ð¹Ð½
      const receiver = onlineUsers.get(receiverId);
      if (receiver) {
        io.to(receiver.socketId).emit('new_private_message', message);
      }

      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŽ
      socket.emit('new_private_message', message);

      console.log(`ðŸ’¬ ${socket.username} -> ${receiverId}: ${content}`);

    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', error);
      socket.emit('message_error', { error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ' });
    }
  });

  // ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚
  socket.on('typing_start', (data) => {
    const { receiverId } = data;
    typingUsers.set(socket.userId, {
      username: socket.username,
      receiverId,
      timestamp: Date.now()
    });

    const receiver = onlineUsers.get(receiverId);
    if (receiver) {
      io.to(receiver.socketId).emit('user_typing', {
        userId: socket.userId,
        username: socket.username
      });
    }
  });

  socket.on('typing_stop', (data) => {
    const { receiverId } = data;
    typingUsers.delete(socket.userId);

    const receiver = onlineUsers.get(receiverId);
    if (receiver) {
      io.to(receiver.socketId).emit('user_stop_typing', {
        userId: socket.userId
      });
    }
  });

  // ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  socket.on('disconnect', async () => {
    if (socket.userId) {
      onlineUsers.delete(socket.userId);
      typingUsers.delete(socket.userId);

      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð² Ð±Ð°Ð·Ðµ
      await supabase
        .from('users')
        .update({ status: 'ÐÐµ Ð² ÑÐµÑ‚Ð¸', last_seen: new Date().toISOString() })
        .eq('id', socket.userId);

      io.emit('online_users_update', Array.from(onlineUsers.values()));

      console.log(`ðŸ‘¤ ${socket.username} Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ð»ÑÑ`);
    }
  });
});

// Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
function getRandomAvatar() {
  const avatars = ['ðŸ‘¤', 'ðŸ‘¨', 'ðŸ‘©', 'ðŸ§‘', 'ðŸ‘¦', 'ðŸ‘§', 'ðŸ¦¸', 'ðŸ¦¹', 'ðŸ§™', 'ðŸ§š', 'ðŸ§›', 'ðŸ§œ'];
  return avatars[Math.floor(Math.random() * avatars.length)];
}

// Health check
app.get('/health', async (req, res) => {
  try {
    const { data, error } = await supabase
      .from('users')
      .select('count')
      .limit(1);

    res.json({
      status: 'healthy',
      database: error ? 'disconnected' : 'connected',
      online_users: onlineUsers.size,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    res.status(500).json({ status: 'unhealthy', error: error.message });
  }
});

// Ð¡Ñ‚Ð°Ñ€Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3000;

async function startServer() {
  await initializeDatabase();
  
  server.listen(PORT, () => {
    console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
    console.log(`ðŸ“± Local Messenger Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ`);
    console.log(`ðŸ‘¥ ÐžÐ½Ð»Ð°Ð¹Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹: ${onlineUsers.size}`);
  });
}

startServer();
